# AGENTS.md

B 站视频自动字幕 Tampermonkey 脚本开发指南

## 项目概述

这是一个单文件的 Tampermonkey 用户脚本，集成音频提取、腾讯云 AI 识别和原生级字幕渲染功能。

## 核心技术实现

### 0. 配置管理 (ConfigManager)
- **安全存储**：使用 Tampermonkey 的 `GM_setValue` / `GM_getValue` API 将密钥加密存储在浏览器本地。
- **配置验证**：提供 `validate()` 方法检查配置完整性。
- **UI 集成**：提供可视化配置面板，用户无需修改代码。

### 1. 音频提取 (AudioExtractor)
- **DASH 解析**：通过 `window.__playinfo__` 获取高码率 DASH 音频流 URL。
- **格式处理**：优先下载 m4a 格式，与腾讯云 API 兼容性最好。
- **缓存机制**：使用 `CacheManager` (IndexedDB) 存储 Blob 数据，避免重复下载，设置 100MB 自动清理阈值。

### 2. 音频压缩 (AudioCompressor)
- **ffmpeg.wasm 集成**：使用 ffmpeg.wasm v0.12.x 实现浏览器端音频处理。
- **智能检测**：
  - 自动检测音频文件大小是否超过 50MB（腾讯云 API 限制）。
  - 提供 `needsCompression()` 方法供外部调用判断。
- **压缩引擎**：
  - **懒加载**：首次调用时才加载 FFmpeg WASM 模块（约 30MB）。
  - **复用机制**：加载后缓存实例，避免重复下载。
  - **进度回调**：支持压缩进度监听（0-100%）。
- **压缩参数**：
  - 输入格式：m4a
  - 输出格式：opus（更高压缩率）
  - 比特率：32kbps
  - 采样率：16kHz
  - 声道：单声道
- **错误处理**：完善的异常捕获和提示机制。

### 3. AI 识别服务 (AISubtitleService)
- **API 对接**：对接腾讯云录音文件识别极速版 (`/asr/flash/v1`)。
- **压缩集成**：
  - 识别前自动检测文件大小。
  - 超过 50MB 自动调用 AudioCompressor 压缩。
  - 支持进度回调（压缩进度、上传状态）。
- **签名鉴权**：
  - 内置纯 JavaScript 实现的 HMAC-SHA1 算法 (`HmacSha1`)，不依赖 `Web Crypto API`，确保在所有 Tampermonkey 环境下的兼容性。
  - 实现参数字典序排序和签名原文拼接。
- **多格式支持**：自动适配 m4a / opus 格式参数。
- **智能分段算法 (`_jsonToSrt`)**：
  - **输入**：API 返回的 `sentence_list` (粗粒度) 和 `word_list` (词级)。
  - **逻辑**：
    1. 修正词级时间戳（累加 `sentence.start_time`）。
    2. 遍历单词，累积构建短句。
    3. **断句条件**：
       - 遇到标点符号 (`，。！？` 等)。
       - 当前句长超过 20 字符。
       - 单词间停顿超过 500ms。
  - **输出**：生成时间轴精准、长短适宜的 SRT 格式字幕。

### 4. 字幕渲染 (SubtitleRenderer)
- **DOM 注入**：自动侦测 B 站播放器容器 (`.bpx-player-video-area`) 并插入字幕层。
- **样式复刻**：
  - 使用半透明黑底 (`rgba(0,0,0,0.6)`) 和白色文字。
  - CSS 样式注入隔离 (`bili-auto-subtitle-style`)。
- **自适应缩放**：监听播放器 `ResizeObserver`，动态计算 `font-size` (约为宽度的 3.5%)。
- **同步机制**：使用 `requestAnimationFrame` 轮询 `video.currentTime`，实现高帧率同步。

## 开发调试

### 密钥配置
在 `TENCENT_CONFIG` 常量中配置测试用的 API Key。实际发布时应提醒用户替换。

### 调试控制台
脚本会在控制台输出关键日志：
- `[AudioExtractor]`: 音频流解析和下载进度。
- `[AISubtitleService]`: 签名原文和 API 响应状态。
- `[SubtitleRenderer]`: 字幕加载数量和渲染状态。

## 未来优化方向

### 1. 功能扩展
- **多模型支持**：增加 OpenAI Whisper API 接口支持（需处理 25MB 文件限制和分片上传）。
- **字幕导出**：添加“下载 SRT”按钮，允许用户保存字幕文件。
- **双语字幕**：利用翻译 API 实现实时双语字幕显示。

### 2. 性能与体验
- **样式自定义**：提供字体大小、颜色、背景透明度的用户自定义选项。

## 已实现的优化

### ✅ 安全配置管理（v0.2.0）
- 实现了可视化配置面板，用户可通过 UI 输入和管理 API 密钥。
- 使用 `GM_setValue` 安全存储密钥，避免硬编码泄露风险。
- 首次使用自动引导配置流程。

### ✅ 字幕缓存功能（v0.2.1）
- 实现了字幕缓存机制，避免重复调用 API。
- 字幕数据与音频文件关联存储在 IndexedDB 中。
- **工作流程**：
  1. 首次识别：调用腾讯云 API，识别后自动保存字幕到缓存。
  2. 再次加载：直接从缓存读取，无需重新调用 API，节省成本和时间。
- **缓存管理**：
  - 字幕与音频文件关联存储（同一记录中）。
  - UI 显示缓存状态（"已缓存音频+字幕"或"已缓存音频"）。
  - 按钮文案智能切换（"加载字幕 (使用缓存)"或"生成字幕 (腾讯云 AI)"）。

### ✅ 长视频智能压缩（v0.3.0）
- 集成 **ffmpeg.wasm** 实现浏览器端音频压缩，解决腾讯云 API 50MB 文件大小限制。
- **自动检测机制**：
  - 实时检测音频文件大小。
  - 当文件超过 50MB 时自动启动压缩流程。
  - 小文件（≤50MB）直接上传，无性能损失。
- **压缩策略**：
  - **编码器**：使用 Opus 编码（比 m4a 压缩率更高）。
  - **参数优化**：
    - 比特率：32kbps（语音识别场景足够）
    - 声道：单声道（减少文件大小）
    - 采样率：16kHz（匹配腾讯云 16k_zh 引擎）
  - **压缩效果**：通常可将文件压缩至原大小的 10-20%，大幅降低 API 调用成本。
- **实时进度反馈**：
  - 加载 FFmpeg 引擎进度提示。
  - 压缩进度百分比显示。
  - 压缩完成后显示节省空间比例。
- **技术细节**：
  - 使用 CDN 加载 ffmpeg.wasm 和 ffmpeg-core（约 30MB）。
  - 首次压缩会下载 WASM 文件，后续压缩无需重新加载。
  - 支持 2 小时以上超长视频处理。