# B 站视频自动字幕脚本

一个基于 Tampermonkey 的用户脚本，为 B 站视频自动生成字幕。通过提取视频音频、调用 **AI 语音识别服务**（支持腾讯云/阿里云）进行语音识别，并自动将字幕渲染到视频播放器中。

## 功能特性

### 1. 智能音频提取
- **高质量音源**：优先解析 B 站 DASH 接口，直接获取无损 M4A 音频流，确保最佳识别效果。
- **智能缓存**：使用浏览器 IndexedDB 缓存音频文件和字幕数据（上限 100MB），避免重复下载和调用 API，节省流量和成本。

### 2. AI 极速识别
- **多云支持**：支持腾讯云和阿里云两种 AI 服务提供商，可自由切换。
  - **腾讯云**：录音文件识别极速版 API，识别速度快（通常 30 分钟音频仅需 10 秒）。
  - **阿里云**：智能语音交互 ASR 服务，支持词级时间戳和高准确率识别。
- **智能断句**：
  - 采用 **词级重组算法**，将长语音流拆分为适合阅读的短句。
  - 基于**标点符号**、**自然停顿 (>500ms)** 和**字符长度 (20字)** 进行智能切分。
  - 确保每行字幕简短、语义完整，避免大段文字遮挡画面。

### 3. 原生级字幕渲染
- **沉浸式体验**：复刻 B 站原生 CC 字幕样式（半透明黑底、白色文字、阴影效果）。
- **自适应布局**：字幕大小随播放器宽度自动缩放，完美适配全屏、宽屏和小窗模式。
- **精准同步**：基于 `requestAnimationFrame` 实现毫秒级时间轴同步。

## 安装方法

### 前置要求
- 安装 [Tampermonkey](https://www.tampermonkey.net/) 浏览器扩展。
- 选择一个 AI 服务提供商并注册账号（二选一）：
  - **腾讯云**：注册 [腾讯云账号](https://cloud.tencent.com/) 并开通 [录音文件识别极速版](https://cloud.tencent.com/product/flash-asr)（新用户通常有免费额度）。
  - **阿里云**：注册 [阿里云账号](https://www.aliyun.com/) 并开通 [智能语音交互](https://www.aliyun.com/product/nls)（新用户通常有免费额度）。

### 安装步骤
1. 安装 Tampermonkey 扩展。
2. 创建新脚本，将 `bilibili-auto-subtitle.user.js` 内容复制进去。
3. 保存脚本并刷新 B 站视频页面。
4. **首次使用配置**：
   - 脚本会自动弹出配置面板。
   - 选择服务提供商（腾讯云或阿里云）。
   - 填入相应的 API 密钥（见下方"配置说明"）。
   - 点击"保存"，密钥将安全存储在浏览器本地。
   - *注意：密钥仅存储在您的浏览器中，不会上传到任何服务器。*

## 使用说明

1. **打开视频**：访问任意 B 站视频页，右侧会出现"B站自动字幕"悬浮面板。
2. **配置密钥**（首次使用）：点击"⚙️ 设置"按钮，选择服务提供商并输入相应 API 密钥，点击保存。
3. **提取音频**：点击"提取音频"，脚本会自动下载并缓存音频。
4. **生成字幕**：下载完成后点击"生成字幕 (AI服务商名称)"，脚本将上传音频并获取字幕。
   - 腾讯云：通常 10-30 秒即可完成识别。
   - 阿里云：采用异步识别，需要等待 30-120 秒（脚本会自动轮询结果）。
5. **观看视频**：字幕生成后会自动加载，随视频播放同步显示。
6. **再次访问**：已识别过的视频会显示"已缓存音频+字幕"，点击"加载字幕 (使用缓存)"即可直接加载，无需重新调用 API。

## 配置说明

脚本提供了**可视化配置界面**，无需修改代码：

### 通用配置步骤
1. 点击悬浮面板上的"⚙️ 设置"按钮。
2. 在"选择服务提供商"下拉菜单中选择腾讯云或阿里云。
3. 根据选择填入相应的密钥信息（见下方各服务商说明）。
4. 点击"保存"完成配置。

### 腾讯云 API 配置

**需要的信息**：
- **APPID**：腾讯云账号 APPID
- **SECRET_ID**：API 密钥 ID
- **SECRET_KEY**：API 密钥 Key

**获取密钥**：
1. 访问 [腾讯云 API 密钥管理](https://console.cloud.tencent.com/cam/capi)。
2. 新建密钥，获取 `SecretId` 和 `SecretKey`。
3. 访问 [账号信息](https://console.cloud.tencent.com/developer) 获取 `APPID`。

### 阿里云 API 配置

**需要的信息**：
- **ACCESS_KEY_ID**：阿里云访问密钥 ID
- **ACCESS_KEY_SECRET**：阿里云访问密钥 Secret
- **APP_KEY**：智能语音交互项目的 AppKey

**获取密钥**：
1. 访问 [阿里云 AccessKey 管理](https://ram.console.aliyun.com/manage/ak)。
2. 创建 AccessKey，获取 `AccessKeyId` 和 `AccessKeySecret`。
3. 访问 [智能语音交互控制台](https://nls-portal.console.aliyun.com/applist)。
4. 创建项目，获取项目的 `AppKey`。

### 安全性说明
- 密钥通过 Tampermonkey 的 `GM_setValue` API 存储在浏览器本地。
- 数据不会上传到任何第三方服务器。
- 您可以随时通过"设置"按钮修改或更新密钥。

## 技术架构

- **音频提取**：解析 `window.__playinfo__` 获取 DASH 音频流。
- **缓存层**：`CacheManager` 模块封装 IndexedDB，实现 FIFO 缓存淘汰策略，同时缓存音频文件和字幕数据。
- **识别层**：
  - `TencentCloudProvider`：实现腾讯云录音识别极速版 API 对接。
  - `AlibabaCloudProvider`：实现阿里云智能语音交互 API 对接（异步识别+轮询）。
  - 统一的 HMAC-SHA1 签名鉴权（纯 JS 实现，无外部依赖）。
- **字幕缓存**：识别成功后自动保存字幕到 IndexedDB，再次访问时优先读取缓存，避免重复调用 API。
- **解析层**：`SRTParser` 负责解析字幕，`SubtitleRenderer` 负责 DOM 渲染。
- **配置管理**：`ConfigManager` 支持多服务商配置，自动迁移旧版本数据。

## 常见问题

### Q: 为什么提示"签名错误"或"API 错误"？
A: 请检查配置的密钥是否正确，且没有多余空格。确保您的云服务账号已开通相应的语音识别服务。

### Q: 腾讯云和阿里云有什么区别？
A: 
- **腾讯云**：识别速度更快（10-30秒），适合快速生成字幕。
- **阿里云**：识别准确率更高，支持更多音频格式，但识别时间稍长（30-120秒）。
- 建议根据您的需求和已有的云服务账号选择。

### Q: 字幕时间对不上？
A: 脚本已内置时间戳修正逻辑。如果仍有偏差，可能是网络延迟或音频文件版本问题，尝试点击"重新生成"或刷新页面。

### Q: 字幕缓存存储在哪里？
A: 字幕和音频文件一起存储在浏览器的 IndexedDB 中，与视频 ID 关联。缓存总量超过 100MB 时会自动清理旧记录。

### Q: 如何清除缓存的字幕？
A: 可以在浏览器开发者工具的 Application/Storage 标签中，找到 IndexedDB -> BilibiliSubtitleCache，手动删除记录。或者等待缓存自动清理。

## 许可证

MIT License
